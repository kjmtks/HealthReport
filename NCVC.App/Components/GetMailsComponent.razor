@using NCVC.App.Models;
@using Microsoft.Extensions.Configuration;
@using Microsoft.EntityFrameworkCore;
@inject IJSRuntime JS;
@inject DatabaseService DB;
@inject NotifierService Notifier;
@inject IConfiguration Config;
@inject AuthenticationStateProvider Auth;
@inject EnvironmentVariableService EV;



<a class="@CssClass" @onclick="UpdateAsync">
    @if (Processing)
    {
        <i class="icons">
            <i class="notched circle loading icon"></i>
        </i>
    }
    else
    {
        @if (IsAll)
        {
            <i class="icons">
                <i class="sync alternate icon"></i>
                <i class="inverted corner add icon"></i>
            </i>
        }
        else
        {
            <i class="icons">
                <i class="sync alternate icon"></i>
            </i>
        }
    }
</a>


@code{
    [Parameter]
    public string CssClass { get; set; }

    [Parameter]
    public bool IsAll { get; set; }

    [Parameter]
    public Course Course { get; set; }

    protected bool Processing { get; set; }

    public string MailMessage { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    protected async Task UpdateAsync()
    {
        if (!Processing)
        {
            Processing = true;
            await InvokeAsync(() => { StateHasChanged(); });
            await Task.Run(async () =>
            {
                var auth = await Auth.GetAuthenticationStateAsync();
                var staff = DB.Context.Staffs.Where(x => x.Account == auth.User.Identity.Name).FirstOrDefault();
                if (staff == null)
                {
                    return;
                }

                try
                {
                    int index, count;
                    if (IsAll)
                    {
                        (index, count) = await CsvGetter.LoadReceivedCsv(DB.Context, EV, Course, staff, Course.ImapMailIndexOffset);
                    }
                    else
                    {
                        var lastHistroy = DB.Context.Histories.Include(x => x.Operator).ToArray().Where(x => x.CourseId == Course.Id).OrderBy(x => x.OperatedAt).LastOrDefault();
                        if (lastHistroy == null)
                        {
                            (index, count) = await CsvGetter.LoadReceivedCsv(DB.Context, EV, Course, staff, Course.ImapMailIndexOffset);
                        }
                        else
                        {
                            (index, count) = await CsvGetter.LoadReceivedCsv(DB.Context, EV, Course, staff, lastHistroy.LastIndex);
                        }
                    }
                    if(count == 0)
                    {
                        MailMessage = "新着メールはありません．";
                    }
                    else
                    {
                        MailMessage = "データベースを更新しました．";
                    }
                }
                catch (Exception e)
                {
                    MailMessage = e.Message;
                }
            });
            Processing = false;
            await Notifier.Update();
        }
    }
}